<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bob</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg: #f5f5f7;
        --surface: #ffffff;
        --surface-hover: #fafafa;
        --surface-inset: #f0f0f2;
        --border: rgba(0, 0, 0, 0.06);
        --border-strong: rgba(0, 0, 0, 0.1);
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06),
          0 1px 3px rgba(0, 0, 0, 0.04);
        --text-primary: #1d1d1f;
        --text-secondary: #6e6e73;
        --text-tertiary: #86868b;
        --accent: #0071e3;
        --accent-subtle: rgba(0, 113, 227, 0.08);
        --green: #34c759;
        --green-subtle: rgba(52, 199, 89, 0.1);
        --red: #ff3b30;
        --red-subtle: rgba(255, 59, 48, 0.08);
        --orange: #ff9500;
        --orange-subtle: rgba(255, 149, 0, 0.1);
        --purple: #af52de;
        --purple-subtle: rgba(175, 82, 222, 0.1);
        --cyan: #32ade6;
        --cyan-subtle: rgba(50, 173, 230, 0.1);
        --diff-del-bg: rgba(255, 59, 48, 0.06);
        --diff-del-text: #c0392b;
        --diff-add-bg: rgba(52, 199, 89, 0.06);
        --diff-add-text: #1e8449;
        --code-bg: rgba(0, 0, 0, 0.03);
        --code-border: rgba(0, 0, 0, 0.06);
        --radius: 12px;
        --radius-sm: 8px;
        --nav-bg: rgba(255, 255, 255, 0.72);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #000000;
          --surface: #1c1c1e;
          --surface-hover: #2c2c2e;
          --surface-inset: #0a0a0a;
          --border: rgba(255, 255, 255, 0.08);
          --border-strong: rgba(255, 255, 255, 0.14);
          --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
          --shadow: 0 1px 3px rgba(0, 0, 0, 0.4),
            0 1px 2px rgba(0, 0, 0, 0.3);
          --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4),
            0 1px 3px rgba(0, 0, 0, 0.3);
          --text-primary: #f5f5f7;
          --text-secondary: #a1a1a6;
          --text-tertiary: #6e6e73;
          --accent: #0a84ff;
          --accent-subtle: rgba(10, 132, 255, 0.15);
          --green: #30d158;
          --green-subtle: rgba(48, 209, 88, 0.15);
          --red: #ff453a;
          --red-subtle: rgba(255, 69, 58, 0.15);
          --orange: #ff9f0a;
          --orange-subtle: rgba(255, 159, 10, 0.15);
          --purple: #bf5af2;
          --purple-subtle: rgba(191, 90, 242, 0.15);
          --cyan: #64d2ff;
          --cyan-subtle: rgba(100, 210, 255, 0.15);
          --diff-del-bg: rgba(255, 69, 58, 0.1);
          --diff-del-text: #ff6961;
          --diff-add-bg: rgba(48, 209, 88, 0.1);
          --diff-add-text: #4ddb80;
          --code-bg: rgba(255, 255, 255, 0.05);
          --code-border: rgba(255, 255, 255, 0.1);
          --nav-bg: rgba(28, 28, 30, 0.72);
        }
      }

      body {
        background: var(--bg);
        color: var(--text-primary);
        font-family:
          -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          system-ui, sans-serif;
        font-size: 15px;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      /* ── Nav ── */
      nav {
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        align-items: center;
        padding: 0 32px;
        height: 52px;
        background: var(--nav-bg);
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 1px solid var(--border);
      }
      .nav-brand {
        font-size: 17px;
        font-weight: 600;
        letter-spacing: -0.02em;
        color: var(--text-primary);
        text-decoration: none;
      }
      .nav-brand:hover {
        color: var(--text-primary);
        text-decoration: none;
      }

      /* ── Page ── */
      .page {
        max-width: 880px;
        margin: 0 auto;
        padding: 48px 32px 96px;
      }

      .page-head {
        margin-bottom: 8px;
      }
      .page-title {
        font-size: 26px;
        font-weight: 700;
        letter-spacing: -0.03em;
        line-height: 1.25;
      }

      .placeholder {
        color: var(--text-tertiary);
        text-align: center;
        padding: 80px 0;
        font-size: 15px;
      }

      /* ── Overview job list ── */
      .job-list {
        display: flex;
        flex-direction: column;
      }

      .job-row {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 12px 12px;
        margin: 0 -12px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        color: inherit;
        text-decoration: none;
        transition: background 0.15s;
      }
      .job-row:hover {
        background: var(--surface);
        text-decoration: none;
      }

      .status-pip {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .pip-running {
        background: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-subtle);
        animation: pulse 2s ease-in-out infinite;
      }
      .pip-completed {
        background: var(--green);
      }
      .pip-error {
        background: var(--red);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }

      .job-row-task {
        flex: 1;
        font-size: 15px;
        font-weight: 500;
        color: var(--text-primary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .job-row-time {
        font-size: 13px;
        color: var(--text-tertiary);
        white-space: nowrap;
      }

      /* ── Job header ── */
      .job-hdr {
        margin-bottom: 32px;
      }
      .job-back {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: var(--text-tertiary);
        margin-bottom: 20px;
        transition: color 0.15s;
      }
      .job-back:hover {
        color: var(--text-primary);
        text-decoration: none;
      }
      .job-hdr-title {
        font-size: 26px;
        font-weight: 700;
        line-height: 1.25;
        letter-spacing: -0.03em;
        margin-bottom: 12px;
        color: var(--text-primary);
      }
      .job-hdr-meta {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 4px 0;
        font-size: 14px;
        color: var(--text-secondary);
      }
      .job-hdr-meta a {
        color: var(--text-secondary);
        transition: color 0.15s;
      }
      .job-hdr-meta a:hover {
        color: var(--text-primary);
        text-decoration: none;
      }
      .meta-sep {
        margin: 0 10px;
        color: var(--text-tertiary);
        opacity: 0.4;
        user-select: none;
      }
      .job-live {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--green);
        font-weight: 500;
      }

      /* ── Stats bar ── */
      .stats-bar {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 4px 0;
        margin-bottom: 28px;
        font-size: 14px;
        color: var(--text-secondary);
      }

      .job-row-cost {
        font-size: 13px;
        color: var(--text-secondary);
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
      }

      .live-pip {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--green);
        animation: pulse 1.5s ease-in-out infinite;
      }

      /* ── Step timeline ── */
      .step-list {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .step-line {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 2px;
        font-family: "SF Mono", ui-monospace, monospace;
        font-size: 13px;
        line-height: 1.5;
      }

      .step-dot {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .step-pulse {
        display: block;
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-subtle);
        animation: pulse 1.5s ease-in-out infinite;
      }

      .step-nm {
        font-weight: 500;
        color: var(--text-secondary);
        white-space: nowrap;
      }

      .step-desc {
        color: var(--text-tertiary);
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .step-desc a {
        color: var(--accent);
      }

      .step-dur {
        font-size: 12px;
        color: var(--text-tertiary);
        white-space: nowrap;
        padding-left: 12px;
      }

      /* ── CC section spacing within step list ── */
      .step-list .cc-section {
        margin: 6px 0;
      }

      /* ── Job footer ── */
      .job-footer {
        display: flex;
        align-items: baseline;
        flex-wrap: wrap;
        gap: 6px 10px;
        padding: 14px 2px 0;
        border-top: 1px solid var(--border);
        margin-top: 16px;
        font-family: "SF Mono", ui-monospace, monospace;
        font-size: 13px;
      }

      .job-footer-ok {
        color: var(--green);
      }

      .job-footer-err {
        color: var(--red);
      }

      .job-footer-icon {
        flex-shrink: 0;
        font-size: 14px;
      }

      .job-footer-msg {
        flex: 1;
        color: var(--text-secondary);
      }

      .job-footer-meta {
        font-size: 12px;
        color: var(--text-tertiary);
        white-space: nowrap;
      }

      /* ── Claude Code output ── */
      .cc-section {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        margin: 8px 0;
        background: var(--surface);
        box-shadow: var(--shadow-sm);
      }
      .cc-label {
        padding: 8px 18px;
        background: var(--surface-inset);
        border-bottom: 1px solid var(--border);
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: var(--text-tertiary);
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .cc-label-status {
        font-size: 11px;
      }
      .cc-label-dur {
        font-size: 11px;
        font-family: "SF Mono", ui-monospace, monospace;
        font-weight: 400;
        letter-spacing: 0;
        text-transform: none;
      }
      .cc-content {
        padding: 10px 0;
        max-height: 300px;
        overflow-y: auto;
      }
      .cc-section.expanded .cc-content {
        max-height: none;
      }
      .cc-section .cc-label {
        cursor: pointer;
        transition: background 0.1s ease;
      }
      .cc-section .cc-label:hover {
        background: var(--surface-hover);
      }
      .cc-section-terminal .cc-text {
        font-family: "SF Mono", ui-monospace, monospace;
      }

      .cc-text {
        padding: 3px 18px;
        font-size: 14px;
        color: var(--text-primary);
        line-height: 1.6;
      }
      .cc-text + .cc-text {
        margin-top: 2px;
      }

      .cc-row {
        display: flex;
        align-items: baseline;
        gap: 8px;
        padding: 3px 18px;
        font-family: "SF Mono", ui-monospace, monospace;
        font-size: 13px;
      }
      .cc-arrow {
        color: var(--text-tertiary);
      }
      .cc-nm {
        color: var(--text-secondary);
        font-weight: 600;
        min-width: 46px;
        font-size: 13px;
      }
      .cc-arg {
        color: var(--text-tertiary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 13px;
      }

      /* ── Diff block ── */
      .cc-diff {
        margin: 10px 18px;
        border-radius: var(--radius-sm);
        overflow: hidden;
        font-family: "SF Mono", ui-monospace, monospace;
        font-size: 13px;
        border: 1px solid var(--border);
      }
      .cc-diff-hdr {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: var(--surface-inset);
        border-bottom: 1px solid var(--border);
        font-size: 12px;
      }
      .cc-diff-path {
        color: var(--text-primary);
        font-size: 12px;
      }
      .diff-lines {
        overflow: hidden;
      }
      .dl {
        padding: 1px 12px;
        white-space: pre;
        overflow-x: auto;
        line-height: 1.6;
        font-size: 13px;
      }
      .dl-del {
        background: var(--diff-del-bg);
        color: var(--diff-del-text);
      }
      .dl-add {
        background: var(--diff-add-bg);
        color: var(--diff-add-text);
      }
      .dl-sep {
        background: var(--surface-inset);
        color: var(--text-tertiary);
        text-align: center;
        padding: 2px 12px;
      }

      /* ── TodoWrite checklist ── */
      .cc-todos {
        margin: 10px 18px;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--surface-inset);
      }
      .cc-todo {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 4px 0;
        font-size: 13px;
        color: var(--text-secondary);
      }
      .todo-i {
        flex-shrink: 0;
        font-size: 14px;
        margin-top: 1px;
        font-family: monospace;
      }
      .todo-pending .todo-i {
        color: var(--text-tertiary);
      }
      .todo-in_progress .todo-i {
        color: var(--accent);
      }
      .todo-completed .todo-i {
        color: var(--green);
      }
      .todo-completed .todo-t {
        text-decoration: line-through;
        color: var(--text-tertiary);
      }

      /* ── Inline markdown ── */
      .cc-text strong {
        color: var(--text-primary);
        font-weight: 600;
      }
      .cc-text em {
        font-style: italic;
      }
      .cc-code {
        background: var(--code-bg);
        border: 1px solid var(--code-border);
        border-radius: 4px;
        padding: 1px 6px;
        font-family: "SF Mono", ui-monospace, monospace;
        font-size: 0.88em;
        color: var(--text-primary);
      }
      .cc-li {
        display: flex;
        align-items: baseline;
        gap: 8px;
        padding: 2px 18px;
      }
      .cc-li-sym {
        color: var(--text-tertiary);
        flex-shrink: 0;
        font-size: 11px;
        min-width: 14px;
        text-align: right;
      }
      .cc-li .cc-li-sym {
        padding-left: 0;
      }

      /* ── Collapsible cc rows (thinking / read-group / agents) ── */
      .cc-thinking,
      .cc-group,
      .cc-agents {
        margin: 4px 18px;
        font-size: 13px;
        font-family: "SF Mono", ui-monospace, monospace;
      }
      .cc-thinking summary,
      .cc-group summary,
      .cc-agents summary {
        cursor: pointer;
        color: var(--text-secondary);
        padding: 2px 0;
        list-style: none;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .cc-thinking summary::-webkit-details-marker,
      .cc-group summary::-webkit-details-marker,
      .cc-agents summary::-webkit-details-marker { display: none; }
      .cc-thinking summary:hover,
      .cc-group summary:hover,
      .cc-agents summary:hover { color: var(--text-primary); }
      /* Rotating expand arrow */
      .cc-thinking summary::before,
      .cc-group summary::before,
      .cc-agents summary::before {
        content: "›";
        font-size: 15px;
        color: var(--text-tertiary);
        transition: transform 0.15s ease;
        flex-shrink: 0;
      }
      details.cc-thinking[open] summary::before,
      details.cc-group[open] summary::before,
      details.cc-agents[open] summary::before {
        transform: rotate(90deg);
      }

      .cc-thinking-body {
        margin-top: 6px;
        padding: 8px 12px;
        background: var(--surface-inset);
        border-radius: var(--radius-sm);
        font-size: 12px;
        color: var(--text-secondary);
        white-space: pre-wrap;
        overflow-wrap: break-word;
        border: 1px solid var(--border);
        max-height: 300px;
        overflow-y: auto;
      }
      .cc-agents-body {
        margin-top: 4px;
        padding: 6px 12px;
        background: var(--surface-inset);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
      }
      .cc-agents-item {
        padding: 3px 0;
        font-size: 13px;
        color: var(--text-secondary);
      }
      .cc-group ul {
        margin-top: 4px;
        padding: 6px 12px;
        background: var(--surface-inset);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        list-style: none;
      }
      .cc-group li {
        padding: 2px 0;
        font-size: 12px;
        color: var(--text-tertiary);
      }

      /* ── Tool error ── */
      .cc-error {
        padding: 3px 18px;
        font-size: 13px;
        font-family: "SF Mono", ui-monospace, monospace;
        color: var(--red);
      }

      /* ── Scrollbar ── */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border-strong);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-tertiary);
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="/" class="nav-brand">Bob</a>
    </nav>
    <div class="page" id="app">
      <div class="placeholder">Loading&hellip;</div>
    </div>
    <script>
      (function () {
        var path = window.location.pathname;
        var m = path.match(/^\/jobs\/([^\/]+)/);
        if (m) {
          initJob(m[1]);
        } else {
          initOverview();
        }

        // ── Overview ─────────────────────────────────────────────────────────────────

        function initOverview() {
          document.title = "Bob";
          loadOverview();
          setInterval(loadOverview, 10000);
        }

        var cachedStats = null;

        function loadOverview() {
          Promise.all([
            fetch("/api/jobs").then(function (r) { return r.json(); }),
            fetch("/api/stats").then(function (r) { return r.json(); }).catch(function () { return null; }),
          ]).then(function (results) {
            cachedStats = results[1];
            renderOverview(results[0]);
          }).catch(function () {
            app('<div class="placeholder">Failed to load.</div>');
          });
        }

        function renderOverview(jobs) {
          if (!jobs || !jobs.length) {
            app(
              '<div class="placeholder">No jobs yet &mdash; mention Bob in Slack with a task to get started.</div>',
            );
            return;
          }

          var statParts = [];
          statParts.push(jobs.length + " job" + (jobs.length !== 1 ? "s" : ""));
          if (cachedStats) {
            var s = cachedStats;
            if (s.total_cost_usd) statParts.push(fmtCost(s.total_cost_usd) + " spent");
            if (s.total_input_tokens) statParts.push(fmtTokens(s.total_input_tokens) + " input");
            if (s.total_output_tokens) statParts.push(fmtTokens(s.total_output_tokens) + " output");
          }
          var statsBar = '<div class="stats-bar">' + statParts.join('<span class="meta-sep">&middot;</span>') + '</div>';

          var rows = jobs
            .map(function (j) {
              var pip = "pip-" + (j.status || "running");
              var ago = relTime(j.started_at);
              var costStr = j.cost_usd ? fmtCost(j.cost_usd) : "";
              return (
                '<a class="job-row" href="/jobs/' +
                enc(j.id) +
                '">' +
                '<span class="status-pip ' +
                pip +
                '"></span>' +
                '<span class="job-row-task">' +
                h(j.task || "(untitled)") +
                "</span>" +
                (costStr ? '<span class="job-row-cost">' + costStr + "</span>" : "") +
                '<span class="job-row-time">' +
                ago +
                "</span>" +
                "</a>"
              );
            })
            .join("");
          app(
            '<div class="page-head">' +
              '<h1 class="page-title">Jobs</h1>' +
              "</div>" +
              statsBar +
              '<div class="job-list">' +
              rows +
              "</div>",
          );
        }

        // ── Job page ─────────────────────────────────────────────────────────────────

        var autoScroll = true;
        var prLink = null;
        var taskText = "";
        var slackURL = "";
        var toolIdx = 0;
        var ccIdx = -1;
        var ccLabel = "Claude Code";
        var jobCostUSD = 0;
        var toolStepMap = {};         // toolIdx → DOM element for in-flight steps
        var pendingReads = [];        // buffer for consecutive Read tool calls
        var pendingThinkingEls = [];  // [{el, ts}] waiting for duration update
        var isLive = false;

        function initJob(id) {
          document.title = "Job " + id.slice(0, 8) + " \u2013 Bob";
          app(
            '<div id="jhdr" class="job-hdr"><div class="job-hdr-title" style="color:var(--text-tertiary)">Loading&hellip;</div></div>' +
              '<div id="evlist" class="step-list"></div>' +
              '<div id="prfooter"></div>',
          );

          window.addEventListener("scroll", function () {
            autoScroll =
              window.scrollY + window.innerHeight >=
              document.body.scrollHeight - 160;
          });

          fetch("/api/jobs/" + id)
            .then(function (r) {
              if (!r.ok) throw 0;
              return r.json();
            })
            .then(function (evts) {
              (evts || []).forEach(addEvt);
              refreshHdr();
              var es = new EventSource("/events?job=" + id);
              isLive = true;
              refreshHdr();
              es.onmessage = function (e) {
                addEvt(JSON.parse(e.data));
                refreshHdr();
                if (autoScroll) window.scrollTo(0, document.body.scrollHeight);
              };
              es.onerror = function () {
                isLive = false;
                refreshHdr();
              };
            })
            .catch(function () {
              app('<div class="placeholder">Job not found.</div>');
            });
        }

        function refreshHdr() {
          var hdr = document.getElementById("jhdr");
          if (!hdr) return;
          var meta = [];
          if (slackURL)
            meta.push('<a href="' + h(slackURL) + '" target="_blank">Slack thread &#8599;</a>');
          if (prLink)
            meta.push('<a href="' + h(prLink) + '" target="_blank">Pull request &#8599;</a>');
          if (jobCostUSD > 0)
            meta.push('<span>' + fmtCost(jobCostUSD) + '</span>');
          if (isLive)
            meta.push('<span class="job-live"><span class="live-pip"></span> Live</span>');
          hdr.innerHTML =
            '<a href="/" class="job-back">&#8592; Jobs</a>' +
            '<div class="job-hdr-title">' +
            h(taskText || "Loading\u2026") +
            "</div>" +
            (meta.length ? '<div class="job-hdr-meta">' + meta.join('<span class="meta-sep">&middot;</span>') + "</div>" : "");

          var footer = document.getElementById("prfooter");
          if (footer) {
            footer.innerHTML = prLink
              ? '<a href="' + h(prLink) + '" target="_blank" style="display:inline-flex;align-items:center;gap:6px;margin-top:24px;font-size:14px;color:var(--text-secondary)">View Pull Request on GitHub &#8599;</a>'
              : "";
          }
        }

        function flushReads(content) {
          if (!pendingReads.length) return;
          var item;
          if (pendingReads.length === 1) {
            item = makeToolItem(pendingReads[0]);
          } else {
            var el = document.createElement("details");
            el.className = "cc-group";
            var paths = pendingReads.map(function(rd) {
              var inp = {};
              try { inp = JSON.parse(rd.tool_input || "{}"); } catch(e) {}
              var fp = inp.file_path || inp.path || "";
              fp = fp.replace(/^\/workspace\/[^\/]+\//, "");
              return "<li>" + h(fp || rd.tool_input || "") + "</li>";
            }).join("");
            el.innerHTML = "<summary>Read " + pendingReads.length + " files</summary><ul>" + paths + "</ul>";
            item = el;
          }
          if (item) content.appendChild(item);
          pendingReads = [];
        }

        function updateThinkingDurations() {
          if (!pendingThinkingEls.length) return;
          var now = Date.now();
          pendingThinkingEls.forEach(function(entry) {
            var span = entry.el.querySelector(".cc-thinking-dur");
            if (span) span.textContent = fmtDuration(now - entry.ts);
          });
          pendingThinkingEls = [];
        }

        function addEvt(ev) {
          var d = ev.data || {};

          // Flush pending Read buffer and thinking durations on non-cc-line events.
          if (ev.type !== "claude_code_line") {
            var content = document.getElementById("cc-content-" + ccIdx);
            if (content) flushReads(content);
            updateThinkingDurations();
          }

          // Accumulate cost.
          if (ev.type === "llm_response" && d.cost_usd !== undefined) {
            jobCostUSD += d.cost_usd;
          }
          if ((ev.type === "job_completed" || ev.type === "job_error") && d.total_cost_usd !== undefined) {
            jobCostUSD = d.total_cost_usd;
          }

          // Extract PR link from create_pull_request completion.
          if (ev.type === "tool_completed" && d.tool_name === "create_pull_request" && !d.is_error) {
            var mm = (d.result_preview || "").match(/https:\/\/github\.com\/[^\s]+\/pull\/\d+/);
            if (mm) prLink = mm[0];
          }

          // job_started: populate header vars only.
          if (ev.type === "job_started") {
            taskText = d.task || "";
            slackURL = d.slack_thread_url || "";
            return;
          }

          // Skip internal plumbing events — cost is already tracked above.
          if (ev.type === "slack_notification" || ev.type === "llm_call" || ev.type === "llm_response") {
            return;
          }

          // Claude Code output line — append to eagerly-created CC content block.
          if (ev.type === "claude_code_line") {
            var content = document.getElementById("cc-content-" + ccIdx);
            if (content) {
              updateThinkingDurations();
              if (d.tool_name === "Read") {
                pendingReads.push(d);
              } else {
                flushReads(content);
                var item = makeCCItem(d);
                if (item) {
                  content.appendChild(item);
                  if (autoScroll) window.scrollTo(0, document.body.scrollHeight);
                }
              }
            }
            return;
          }

          var list = document.getElementById("evlist");
          if (!list) return;

          // tool_started
          if (ev.type === "tool_started") {
            var isCCTool = d.tool_name === "implement_changes" || d.tool_name === "run_tests";

            if (isCCTool) {
              ccIdx = toolIdx;
              ccLabel = d.tool_name === "run_tests" ? "Run Tests" : "Claude Code";

              var sec = document.createElement("div");
              sec.className = "cc-section expanded" + (d.tool_name === "run_tests" ? " cc-section-terminal" : "");
              sec.id = "cc-sec-" + ccIdx;
              sec.innerHTML =
                '<div class="cc-label">' +
                h(ccLabel) +
                '</div>' +
                '<div class="cc-content" id="cc-content-' + ccIdx + '"></div>';
              sec.querySelector(".cc-label").addEventListener("click", function () {
                sec.classList.toggle("expanded");
              });
              list.appendChild(sec);
            } else {
              // Regular orchestrator step: show as a step row with spinner.
              var desc = d.input || "";
              if (desc.length > 64) desc = desc.slice(0, 64) + "\u2026";
              var el = createStepRow(toolIdx, d.tool_name, desc, "running", "");
              toolStepMap[toolIdx] = el;
              list.appendChild(el);
            }
            return;
          }

          // tool_completed
          if (ev.type === "tool_completed") {
            var isCCTool = d.tool_name === "implement_changes" || d.tool_name === "run_tests";

            if (isCCTool) {
              var sec = document.getElementById("cc-sec-" + ccIdx);
              if (sec) {
                var label = sec.querySelector(".cc-label");
                if (label) {
                  var dur = d.duration_ms !== undefined ? fmtDuration(d.duration_ms) : "";
                  var statusIcon = d.is_error
                    ? '<span class="cc-label-status" style="color:var(--red)">✗</span>'
                    : '<span class="cc-label-status" style="color:var(--green)">✓</span>';
                  label.innerHTML =
                    h(ccLabel) +
                    statusIcon +
                    (dur ? '<span class="cc-label-dur">' + h(dur) + '</span>' : '');
                }
              }
            } else {
              var el = toolStepMap[toolIdx];
              if (el) updateStepRow(el, d);
            }

            toolIdx++;
            return;
          }

          // job_completed
          if (ev.type === "job_completed") {
            var footer = createJobFooter(false, d);
            list.appendChild(footer);
            return;
          }

          // job_error
          if (ev.type === "job_error") {
            var footer = createJobFooter(true, d);
            list.appendChild(footer);
            return;
          }
        }

        // ── Step row helpers ──────────────────────────────────────────────────────────

        function createStepRow(idx, toolName, desc, status, dur) {
          var el = document.createElement("div");
          el.className = "step-line";
          el.id = "step-" + idx;
          el.innerHTML = stepRowInner(toolName, desc, status, dur, null);
          return el;
        }

        function stepRowInner(toolName, desc, status, dur, prURL) {
          var dotHtml;
          if (status === "running") {
            dotHtml = '<span class="step-dot"><span class="step-pulse"></span></span>';
          } else if (status === "error") {
            dotHtml = '<span class="step-dot" style="color:var(--red)">✗</span>';
          } else {
            dotHtml = '<span class="step-dot" style="color:var(--green)">✓</span>';
          }
          var descHtml = "";
          if (prURL) {
            descHtml = '<span class="step-desc"><a href="' + h(prURL) + '" target="_blank">' + h(desc) + '</a></span>';
          } else if (desc) {
            descHtml = '<span class="step-desc">' + h(desc) + '</span>';
          }
          return (
            dotHtml +
            '<span class="step-nm">' + h(toolName) + '</span>' +
            descHtml +
            (dur ? '<span class="step-dur">' + h(dur) + '</span>' : '<span class="step-dur"></span>')
          );
        }

        function updateStepRow(el, d) {
          if (!el) return;
          var isErr = d.is_error;
          var status = isErr ? "error" : "ok";
          var dur = d.duration_ms !== undefined ? fmtDuration(d.duration_ms) : "";

          var nm = el.querySelector(".step-nm");
          var descEl = el.querySelector(".step-desc");
          var toolName = nm ? nm.textContent : "";
          var desc = descEl ? descEl.textContent : "";

          var prURL = null;
          if (d.tool_name === "create_pull_request" && !d.is_error) {
            var m = (d.result_preview || "").match(/https:\/\/github\.com\/[^\s]+\/pull\/\d+/);
            if (m) {
              prURL = m[0];
              desc = m[0].replace("https://github.com/", "");
            }
          }

          el.innerHTML = stepRowInner(toolName, desc, status, dur, prURL);
        }

        function createJobFooter(isErr, d) {
          var el = document.createElement("div");
          el.className = "job-footer " + (isErr ? "job-footer-err" : "job-footer-ok");

          var icon = isErr ? "✗" : "✓";
          var msg = isErr
            ? (d.error || "Job failed")
            : (d.final_response || "Done");

          var meta = "";
          if (d.total_duration_ms !== undefined) meta += fmtDuration(d.total_duration_ms);
          if (d.total_cost_usd !== undefined) meta += (meta ? " \u00b7 " : "") + fmtCost(d.total_cost_usd);

          el.innerHTML =
            '<span class="job-footer-icon">' + icon + '</span>' +
            '<span class="job-footer-msg">' + h(msg) + '</span>' +
            (meta ? '<span class="job-footer-meta">' + h(meta) + '</span>' : '');
          return el;
        }

        // ── Claude Code item rendering ────────────────────────────────────────────────

        function makeCCItem(d) {
          // Thinking block
          if (d.thinking !== undefined) {
            var el = document.createElement("details");
            el.className = "cc-thinking";
            el.innerHTML =
              '<summary>Thought for <span class="cc-thinking-dur">\u2026</span></summary>' +
              '<pre class="cc-thinking-body">' + h(d.thinking) + "</pre>";
            pendingThinkingEls.push({ el: el, ts: d.thinking_ts || Date.now() });
            return el;
          }

          // Tool error
          if (d.tool_error !== undefined) {
            var el = document.createElement("div");
            el.className = "cc-error";
            el.innerHTML = "⚠ <span>" + h(d.tool_error) + "</span>";
            return el;
          }

          // Sub-agent completions
          if (d.agents_finished) {
            var agents = d.agents || [];
            var el = document.createElement("details");
            el.className = "cc-agents";
            var items = agents.map(function(a) {
              return '<div class="cc-agents-item">' + h(a.description || "") + "</div>";
            }).join("");
            el.innerHTML =
              "<summary>" + d.agents_finished + " sub-agent" +
              (d.agents_finished !== 1 ? "s" : "") + " finished</summary>" +
              '<div class="cc-agents-body">' + items + "</div>";
            return el;
          }

          if (d.tool_name) return makeToolItem(d);
          var txt = (d.text || "").trimEnd();
          if (!txt) return null;

          var el = document.createElement("div");

          // Unordered list item: "- text" or "* text"
          var ul = txt.match(/^(\s*)[*\-]\s+(.+)$/);
          if (ul) {
            el.className = "cc-li";
            el.style.paddingLeft = 18 + ul[1].length * 10 + "px";
            el.innerHTML =
              '<span class="cc-li-sym">•</span><span>' +
              renderMd(ul[2]) +
              "</span>";
            return el;
          }

          // Ordered list item: "1. text"
          var ol = txt.match(/^(\s*)(\d+)\.\s+(.+)$/);
          if (ol) {
            el.className = "cc-li";
            el.style.paddingLeft = 18 + ol[1].length * 10 + "px";
            el.innerHTML =
              '<span class="cc-li-sym">' +
              ol[2] +
              ".</span><span>" +
              renderMd(ol[3]) +
              "</span>";
            return el;
          }

          el.className = "cc-text";
          el.innerHTML = renderMd(txt);
          return el;
        }

        // Simple inline markdown: bold+code, bold, italic, backtick code.
        function renderMd(raw) {
          var s = h(raw);
          // **code** combined with backtick spans
          s = s.replace(
            /\*\*\x60([^\x60]+)\x60\*\*/g,
            '<strong><code class="cc-code">$1</code></strong>',
          );
          // **bold**
          s = s.replace(/\*\*([^*\n]+)\*\*/g, "<strong>$1</strong>");
          // *italic*
          s = s.replace(/\*([^*\n]+)\*/g, "<em>$1</em>");
          // backtick code spans
          s = s.replace(
            /\x60([^\x60\n]+)\x60/g,
            '<code class="cc-code">$1</code>',
          );
          return s;
        }

        function makeToolItem(d) {
          var name = d.tool_name || "";
          var input = {};
          try {
            input = JSON.parse(d.tool_input || "{}");
          } catch (e) {}

          if (name === "Edit" || name === "Write")
            return makeDiffItem(name, input);
          if (name === "TodoWrite") return makeTodosItem(input);

          // Simple one-line tool row.
          var arg = toolArg(name, input);
          var el = document.createElement("div");
          el.className = "cc-row";
          el.innerHTML =
            '<span class="cc-arrow">\u00b7</span>' +
            '<span class="cc-nm">' +
            h(name) +
            "</span>" +
            (arg ? '<span class="cc-arg">' + h(arg) + "</span>" : "");
          return el;
        }

        function toolArg(name, input) {
          var keys = [
            "file_path",
            "command",
            "path",
            "pattern",
            "glob",
            "query",
            "description",
          ];
          for (var i = 0; i < keys.length; i++) {
            var v = input[keys[i]];
            if (typeof v === "string" && v) {
              var s = v.replace(/^\/workspace\/[^\/]+\//, "");
              return s.length > 72 ? s.slice(0, 72) + "\u2026" : s;
            }
          }
          return "";
        }

        function makeDiffItem(toolName, input) {
          var fp = input.file_path || "";
          var short = fp.replace(/^\/workspace\/[^\/]+\//, "") || fp;
          var oldS = input.old_string || "";
          var newS = input.new_string || input.content || "";

          var MAX = 24;
          var oldLines = oldS.split("\n");
          var newLines = newS.split("\n");
          var oldOver = oldLines.length > MAX;
          var newOver = newLines.length > MAX;
          if (oldOver) oldLines = oldLines.slice(0, MAX);
          if (newOver) newLines = newLines.slice(0, MAX);

          var body = "";
          oldLines.forEach(function (l) {
            body += '<div class="dl dl-del">- ' + h(l) + "</div>";
          });
          if (oldOver)
            body += '<div class="dl dl-sep">\u2026 truncated \u2026</div>';
          newLines.forEach(function (l) {
            body += '<div class="dl dl-add">+ ' + h(l) + "</div>";
          });
          if (newOver)
            body += '<div class="dl dl-sep">\u2026 truncated \u2026</div>';

          var el = document.createElement("div");
          el.className = "cc-diff";
          el.innerHTML =
            '<div class="cc-diff-hdr">' +
            '<span class="cc-arrow">\u00b7</span>' +
            '<span class="cc-nm">' +
            h(toolName) +
            "</span>" +
            '<span class="cc-diff-path">' +
            h(short) +
            "</span>" +
            "</div>" +
            '<div class="diff-lines">' +
            body +
            "</div>";
          return el;
        }

        function makeTodosItem(input) {
          var todos = input.todos || [];
          if (!todos.length) return null;
          var el = document.createElement("div");
          el.className = "cc-todos";
          todos.forEach(function (t) {
            var status = t.status || "pending";
            var icon =
              status === "completed"
                ? "\u2713"
                : status === "in_progress"
                  ? "\u25cf"
                  : "\u25cb";
            var row = document.createElement("div");
            row.className = "cc-todo todo-" + status;
            row.innerHTML =
              '<span class="todo-i">' +
              icon +
              '</span><span class="todo-t">' +
              h(t.content || "") +
              "</span>";
            el.appendChild(row);
          });
          return el;
        }

        // ── Cost / Token helpers ─────────────────────────────────────────────────────

        function fmtCost(usd) {
          if (usd === undefined || usd === null) return "";
          if (usd < 0.01 && usd > 0) return "<$0.01";
          return "$" + usd.toFixed(2);
        }

        function fmtTokens(n) {
          if (n === undefined || n === null || n === 0) return "0";
          if (n >= 1e6) return (n / 1e6).toFixed(1) + "M";
          if (n >= 1e3) return (n / 1e3).toFixed(1) + "k";
          return String(n);
        }

        function fmtDuration(ms) {
          if (ms === undefined || ms === null) return "";
          if (ms < 1000) return ms + "ms";
          var s = ms / 1000;
          if (s < 60) return s.toFixed(1) + "s";
          var m = Math.floor(s / 60);
          var rem = Math.floor(s % 60);
          return m + "m " + rem + "s";
        }

        // ── Helpers ───────────────────────────────────────────────────────────────────

        function app(html) {
          document.getElementById("app").innerHTML = html;
        }

        function h(s) {
          return String(s)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
        }

        function enc(s) {
          return encodeURIComponent(String(s));
        }

        function fmtTs(ts) {
          if (!ts) return "";
          return new Date(ts).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        }

        function relTime(ts) {
          if (!ts) return "";
          var diff = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
          if (diff < 60) return diff + "s ago";
          if (diff < 3600) return Math.floor(diff / 60) + "m ago";
          if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
          return Math.floor(diff / 86400) + "d ago";
        }
      })();
    </script>
  </body>
</html>
