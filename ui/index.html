<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bob</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg: #f5f5f7;
        --surface: #ffffff;
        --surface-hover: #fafafa;
        --surface-inset: #f0f0f2;
        --border: rgba(0, 0, 0, 0.06);
        --border-strong: rgba(0, 0, 0, 0.1);
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06),
          0 1px 3px rgba(0, 0, 0, 0.04);
        --text-primary: #1d1d1f;
        --text-secondary: #6e6e73;
        --text-tertiary: #86868b;
        --accent: #0071e3;
        --accent-subtle: rgba(0, 113, 227, 0.08);
        --green: #34c759;
        --green-subtle: rgba(52, 199, 89, 0.1);
        --red: #ff3b30;
        --red-subtle: rgba(255, 59, 48, 0.08);
        --orange: #ff9500;
        --orange-subtle: rgba(255, 149, 0, 0.1);
        --purple: #af52de;
        --purple-subtle: rgba(175, 82, 222, 0.1);
        --cyan: #32ade6;
        --cyan-subtle: rgba(50, 173, 230, 0.1);
        --diff-del-bg: rgba(255, 59, 48, 0.06);
        --diff-del-text: #c0392b;
        --diff-add-bg: rgba(52, 199, 89, 0.06);
        --diff-add-text: #1e8449;
        --code-bg: rgba(0, 0, 0, 0.03);
        --code-border: rgba(0, 0, 0, 0.06);
        --radius: 12px;
        --radius-sm: 8px;
        --nav-bg: rgba(255, 255, 255, 0.72);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #000000;
          --surface: #1c1c1e;
          --surface-hover: #2c2c2e;
          --surface-inset: #0a0a0a;
          --border: rgba(255, 255, 255, 0.08);
          --border-strong: rgba(255, 255, 255, 0.14);
          --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
          --shadow: 0 1px 3px rgba(0, 0, 0, 0.4),
            0 1px 2px rgba(0, 0, 0, 0.3);
          --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4),
            0 1px 3px rgba(0, 0, 0, 0.3);
          --text-primary: #f5f5f7;
          --text-secondary: #a1a1a6;
          --text-tertiary: #6e6e73;
          --accent: #0a84ff;
          --accent-subtle: rgba(10, 132, 255, 0.15);
          --green: #30d158;
          --green-subtle: rgba(48, 209, 88, 0.15);
          --red: #ff453a;
          --red-subtle: rgba(255, 69, 58, 0.15);
          --orange: #ff9f0a;
          --orange-subtle: rgba(255, 159, 10, 0.15);
          --purple: #bf5af2;
          --purple-subtle: rgba(191, 90, 242, 0.15);
          --cyan: #64d2ff;
          --cyan-subtle: rgba(100, 210, 255, 0.15);
          --diff-del-bg: rgba(255, 69, 58, 0.1);
          --diff-del-text: #ff6961;
          --diff-add-bg: rgba(48, 209, 88, 0.1);
          --diff-add-text: #4ddb80;
          --code-bg: rgba(255, 255, 255, 0.05);
          --code-border: rgba(255, 255, 255, 0.1);
          --nav-bg: rgba(28, 28, 30, 0.72);
        }
      }

      body {
        background: var(--bg);
        color: var(--text-primary);
        font-family:
          -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          system-ui, sans-serif;
        font-size: 15px;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      /* â”€â”€ Nav â”€â”€ */
      nav {
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        align-items: center;
        padding: 0 32px;
        height: 52px;
        background: var(--nav-bg);
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 1px solid var(--border);
      }
      .nav-brand {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 18px;
        font-weight: 600;
        letter-spacing: -0.01em;
        color: var(--text-primary);
        text-decoration: none;
      }
      .nav-brand:hover {
        color: var(--text-primary);
        text-decoration: none;
      }
      .nav-brand .logo-emoji {
        font-size: 1.15em;
        line-height: 1;
      }

      /* â”€â”€ Page â”€â”€ */
      .page {
        max-width: 880px;
        margin: 0 auto;
        padding: 48px 32px 96px;
      }

      .page-head {
        margin-bottom: 32px;
      }
      .page-title {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -0.025em;
        line-height: 1.2;
        margin-bottom: 4px;
      }
      .page-sub {
        color: var(--text-secondary);
        font-size: 15px;
      }

      .placeholder {
        color: var(--text-tertiary);
        text-align: center;
        padding: 80px 0;
        font-size: 15px;
      }

      /* â”€â”€ Overview job list â”€â”€ */
      .job-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .job-row {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 16px 20px;
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
        cursor: pointer;
        color: inherit;
        text-decoration: none;
        transition:
          box-shadow 0.2s ease,
          border-color 0.2s ease;
      }
      .job-row:hover {
        box-shadow: var(--shadow);
        border-color: var(--border-strong);
        text-decoration: none;
      }

      .status-pip {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .pip-running {
        background: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-subtle);
        animation: pulse 2s ease-in-out infinite;
      }
      .pip-completed {
        background: var(--green);
      }
      .pip-error {
        background: var(--red);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }

      .job-row-task {
        flex: 1;
        font-size: 15px;
        font-weight: 500;
        color: var(--text-primary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .job-row-time {
        font-size: 13px;
        color: var(--text-tertiary);
        white-space: nowrap;
      }
      .job-row-id {
        font-size: 12px;
        color: var(--text-tertiary);
        font-family: "SF Mono", ui-monospace, monospace;
        white-space: nowrap;
      }
      .job-row-arrow {
        color: var(--text-tertiary);
        font-size: 16px;
        font-weight: 300;
        margin-left: 2px;
        transition: transform 0.15s ease;
      }
      .job-row:hover .job-row-arrow {
        transform: translateX(2px);
      }

      /* â”€â”€ Job header â”€â”€ */
      .job-hdr {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        padding: 28px 28px 24px;
        margin-bottom: 24px;
      }
      .job-hdr-title {
        font-size: 20px;
        font-weight: 600;
        line-height: 1.35;
        letter-spacing: -0.01em;
        margin-bottom: 16px;
        color: var(--text-primary);
      }
      .job-hdr-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        background: var(--surface-inset);
        color: var(--text-secondary);
        border: none;
        transition: background 0.15s ease;
      }
      .chip-a {
        color: var(--accent);
        background: var(--accent-subtle);
        cursor: pointer;
      }
      .chip-a:hover {
        background: rgba(0, 113, 227, 0.14);
        text-decoration: none;
        color: var(--accent);
      }
      .chip-pr {
        color: var(--green);
        background: var(--green-subtle);
        cursor: pointer;
      }
      .chip-pr:hover {
        background: rgba(52, 199, 89, 0.18);
        text-decoration: none;
      }

      /* â”€â”€ Live bar â”€â”€ */
      .live-bar {
        display: none;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
        padding: 10px 16px;
        background: var(--green-subtle);
        border-radius: var(--radius-sm);
        font-size: 13px;
        font-weight: 500;
        color: var(--green);
        border: none;
      }
      .live-pip {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--green);
        animation: pulse 1.5s ease-in-out infinite;
      }

      /* â”€â”€ Event list â”€â”€ */
      .ev-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .ev {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--surface);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
      }

      .ev-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 18px;
        cursor: pointer;
        transition: background 0.1s ease;
        min-height: 44px;
      }
      .ev-row:hover {
        background: var(--surface-hover);
      }
      .ev-row.static {
        cursor: default;
      }
      .ev-row.static:hover {
        background: transparent;
      }

      /* â”€â”€ Tag â”€â”€ */
      .tag {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 5px;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        white-space: nowrap;
        flex-shrink: 0;
        width: 80px;
        justify-content: center;
      }
      .tag-job {
        background: var(--accent-subtle);
        color: var(--accent);
      }
      .tag-done {
        background: var(--green-subtle);
        color: var(--green);
      }
      .tag-err {
        background: var(--red-subtle);
        color: var(--red);
      }
      .tag-llm {
        background: var(--purple-subtle);
        color: var(--purple);
      }
      .tag-tool {
        background: var(--orange-subtle);
        color: var(--orange);
      }
      .tag-slack {
        background: var(--cyan-subtle);
        color: var(--cyan);
      }

      .ev-name {
        font-size: 14px;
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
      }
      .ev-name strong {
        color: var(--text-primary);
        font-weight: 500;
      }
      .ev-ok {
        color: var(--green);
      }
      .ev-err {
        color: var(--red);
      }

      .dur {
        font-size: 12px;
        color: var(--text-tertiary);
        font-family: "SF Mono", ui-monospace, monospace;
        white-space: nowrap;
      }

      .ev-time {
        font-size: 12px;
        color: var(--text-tertiary);
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
      }

      .ev-caret {
        color: var(--text-tertiary);
        font-size: 14px;
        flex-shrink: 0;
        transition: transform 0.2s ease;
      }
      .ev.open .ev-caret {
        transform: rotate(90deg);
      }

      /* â”€â”€ Event body â”€â”€ */
      .ev-body {
        border-top: 1px solid var(--border);
        padding: 14px 18px;
        font-family: "SF Mono", ui-monospace, monospace;
        font-size: 13px;
        line-height: 1.6;
        color: var(--text-secondary);
        white-space: pre-wrap;
        overflow-wrap: break-word;
        word-break: break-word;
        background: var(--surface-inset);
      }
      .ev.closed .ev-body {
        display: none;
      }

      /* â”€â”€ Claude Code output â”€â”€ */
      .cc-section {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        margin: 8px 0;
        background: var(--surface);
        box-shadow: var(--shadow-sm);
      }
      .cc-label {
        padding: 8px 18px;
        background: var(--surface-inset);
        border-bottom: 1px solid var(--border);
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: var(--text-tertiary);
      }
      .cc-content {
        padding: 10px 0;
        max-height: 300px;
        overflow-y: auto;
      }
      .cc-section.expanded .cc-content {
        max-height: none;
      }
      .cc-section .cc-label {
        cursor: pointer;
        transition: background 0.1s ease;
      }
      .cc-section .cc-label:hover {
        background: var(--surface-hover);
      }
      .cc-section-terminal .cc-text {
        font-family: "SF Mono", ui-monospace, monospace;
      }

      .cc-text {
        padding: 3px 18px;
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
      }
      .cc-text + .cc-text {
        margin-top: 2px;
      }

      .cc-row {
        display: flex;
        align-items: baseline;
        gap: 8px;
        padding: 3px 18px;
        font-family: "SF Mono", ui-monospace, monospace;
        font-size: 13px;
      }
      .cc-arrow {
        color: var(--text-tertiary);
      }
      .cc-nm {
        color: var(--text-secondary);
        font-weight: 600;
        min-width: 46px;
        font-size: 13px;
      }
      .cc-arg {
        color: var(--text-tertiary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 13px;
      }

      /* â”€â”€ Diff block â”€â”€ */
      .cc-diff {
        margin: 10px 18px;
        border-radius: var(--radius-sm);
        overflow: hidden;
        font-family: "SF Mono", ui-monospace, monospace;
        font-size: 13px;
        border: 1px solid var(--border);
      }
      .cc-diff-hdr {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: var(--surface-inset);
        border-bottom: 1px solid var(--border);
        font-size: 12px;
      }
      .cc-diff-path {
        color: var(--text-primary);
        font-size: 12px;
      }
      .diff-lines {
        overflow: hidden;
      }
      .dl {
        padding: 1px 12px;
        white-space: pre;
        overflow-x: auto;
        line-height: 1.6;
        font-size: 13px;
      }
      .dl-del {
        background: var(--diff-del-bg);
        color: var(--diff-del-text);
      }
      .dl-add {
        background: var(--diff-add-bg);
        color: var(--diff-add-text);
      }
      .dl-sep {
        background: var(--surface-inset);
        color: var(--text-tertiary);
        text-align: center;
        padding: 2px 12px;
      }

      /* â”€â”€ TodoWrite checklist â”€â”€ */
      .cc-todos {
        margin: 10px 18px;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--surface-inset);
      }
      .cc-todo {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 4px 0;
        font-size: 13px;
        color: var(--text-secondary);
      }
      .todo-i {
        flex-shrink: 0;
        font-size: 14px;
        margin-top: 1px;
        font-family: monospace;
      }
      .todo-pending .todo-i {
        color: var(--text-tertiary);
      }
      .todo-in_progress .todo-i {
        color: var(--accent);
      }
      .todo-completed .todo-i {
        color: var(--green);
      }
      .todo-completed .todo-t {
        text-decoration: line-through;
        color: var(--text-tertiary);
      }

      /* â”€â”€ Inline markdown â”€â”€ */
      .cc-text strong {
        color: var(--text-primary);
        font-weight: 600;
      }
      .cc-text em {
        font-style: italic;
      }
      .cc-code {
        background: var(--code-bg);
        border: 1px solid var(--code-border);
        border-radius: 4px;
        padding: 1px 6px;
        font-family: "SF Mono", ui-monospace, monospace;
        font-size: 0.88em;
        color: var(--text-primary);
      }
      .cc-li {
        display: flex;
        align-items: baseline;
        gap: 8px;
        padding: 2px 18px;
      }
      .cc-li-sym {
        color: var(--text-tertiary);
        flex-shrink: 0;
        font-size: 11px;
        min-width: 14px;
        text-align: right;
      }
      .cc-li .cc-li-sym {
        padding-left: 0;
      }

      /* â”€â”€ Scrollbar â”€â”€ */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border-strong);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-tertiary);
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="/" class="nav-brand">
        <span class="logo-emoji">ðŸ‘·</span>Bob
      </a>
    </nav>
    <div class="page" id="app">
      <div class="placeholder">Loading&hellip;</div>
    </div>
    <script>
      (function () {
        var path = window.location.pathname;
        var m = path.match(/^\/jobs\/([^\/]+)/);
        if (m) {
          initJob(m[1]);
        } else {
          initOverview();
        }

        // â”€â”€ Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function initOverview() {
          document.title = "Bob";
          loadJobs();
          setInterval(loadJobs, 10000);
        }

        function loadJobs() {
          fetch("/api/jobs")
            .then(function (r) {
              return r.json();
            })
            .then(renderOverview)
            .catch(function () {
              app('<div class="placeholder">Failed to load.</div>');
            });
        }

        function renderOverview(jobs) {
          if (!jobs || !jobs.length) {
            app(
              '<div class="placeholder">No jobs yet &mdash; mention Bob in Slack with a task to get started.</div>',
            );
            return;
          }
          var rows = jobs
            .map(function (j) {
              var pip = "pip-" + (j.status || "running");
              var ago = relTime(j.started_at);
              return (
                '<a class="job-row" href="/jobs/' +
                enc(j.id) +
                '">' +
                '<span class="status-pip ' +
                pip +
                '"></span>' +
                '<span class="job-row-task">' +
                h(j.task || "(untitled)") +
                "</span>" +
                '<span class="job-row-time">' +
                ago +
                "</span>" +
                '<span class="job-row-id">' +
                j.id.slice(0, 8) +
                "</span>" +
                '<span class="job-row-arrow">&#8250;</span>' +
                "</a>"
              );
            })
            .join("");
          app(
            '<div class="page-head">' +
              '<h1 class="page-title">Jobs</h1>' +
              '<p class="page-sub">' +
              jobs.length +
              " job" +
              (jobs.length !== 1 ? "s" : "") +
              "</p>" +
              "</div>" +
              '<div class="job-list">' +
              rows +
              "</div>",
          );
        }

        // â”€â”€ Job page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        var autoScroll = true;
        var prLink = null;
        var taskText = "";
        var slackURL = "";
        var toolIdx = 0;
        var ccIdx = -1;
        var ccLabel = "Claude Code";

        function initJob(id) {
          document.title = "Job " + id.slice(0, 8) + " \u2013 Bob";
          app(
            '<div id="jhdr" class="job-hdr"><div class="job-hdr-title" style="color:var(--text-tertiary)">Loading&hellip;</div></div>' +
              '<div id="lbar" class="live-bar"><span class="live-pip"></span><span>Live</span></div>' +
              '<div id="evlist" class="ev-list"></div>' +
              '<div id="prfooter"></div>',
          );

          window.addEventListener("scroll", function () {
            autoScroll =
              window.scrollY + window.innerHeight >=
              document.body.scrollHeight - 160;
          });

          fetch("/api/jobs/" + id)
            .then(function (r) {
              if (!r.ok) throw 0;
              return r.json();
            })
            .then(function (evts) {
              (evts || []).forEach(addEvt);
              refreshHdr();
              var es = new EventSource("/events?job=" + id);
              document.getElementById("lbar").style.display = "flex";
              es.onmessage = function (e) {
                addEvt(JSON.parse(e.data));
                refreshHdr();
                if (autoScroll) window.scrollTo(0, document.body.scrollHeight);
              };
              es.onerror = function () {
                document.getElementById("lbar").style.display = "none";
              };
            })
            .catch(function () {
              app('<div class="placeholder">Job not found.</div>');
            });
        }

        function refreshHdr() {
          var hdr = document.getElementById("jhdr");
          if (!hdr) return;
          var chips = "";
          if (slackURL)
            chips +=
              '<a href="' +
              h(slackURL) +
              '" target="_blank" class="chip chip-a">&#8599; Slack thread</a>';
          if (prLink)
            chips +=
              '<a href="' +
              h(prLink) +
              '" target="_blank" class="chip chip-pr">&#8594; View PR</a>';
          hdr.innerHTML =
            '<div class="job-hdr-title">' +
            h(taskText || "Loading\u2026") +
            "</div>" +
            (chips ? '<div class="job-hdr-chips">' + chips + "</div>" : "");

          var footer = document.getElementById("prfooter");
          if (footer) {
            footer.innerHTML = prLink
              ? '<a href="' +
                h(prLink) +
                '" target="_blank" class="chip chip-pr" style="display:inline-flex;margin-top:24px;font-size:14px;padding:8px 18px">&#8599; View Pull Request on GitHub</a>'
              : "";
          }
        }

        function addEvt(ev) {
          var d = ev.data || {};

          if (ev.type === "job_started") {
            taskText = d.task || "";
            slackURL = d.slack_thread_url || "";
          }
          if (
            ev.type === "tool_completed" &&
            d.tool_name === "create_pull_request" &&
            !d.is_error
          ) {
            var mm = (d.result_preview || "").match(
              /https:\/\/github\.com\/[^\s]+\/pull\/\d+/,
            );
            if (mm) prLink = mm[0];
          }

          // Claude Code output line â€” append to eagerly-created CC content block.
          if (ev.type === "claude_code_line") {
            var content = document.getElementById("cc-content-" + ccIdx);
            if (content) {
              var item = makeCCItem(d);
              if (item) {
                content.appendChild(item);
                content.scrollTop = content.scrollHeight;
                if (autoScroll) window.scrollTo(0, document.body.scrollHeight);
              }
            }
            return;
          }

          // Track when implement_changes or run_tests starts; the cc-section
          // is eagerly created right after the tool_started row below.
          if (
            ev.type === "tool_started" &&
            (d.tool_name === "implement_changes" || d.tool_name === "run_tests")
          ) {
            ccIdx = toolIdx;
            ccLabel = d.tool_name === "run_tests" ? "Test Output" : "Claude Code";
          }
          if (ev.type === "tool_completed") toolIdx++;

          var list = document.getElementById("evlist");
          if (!list) return;

          var body = evBody(ev);
          var hasBody = body !== "";
          var tag = evTag(ev);
          var name = evName(ev);
          var durStr =
            d.duration_ms !== undefined
              ? '<span class="dur">' + d.duration_ms + "ms</span>"
              : "";

          var el = document.createElement("div");
          el.className = "ev closed";
          var rowCls = "ev-row" + (hasBody ? "" : " static");
          var click = hasBody ? ' onclick="tog(this)"' : "";
          el.innerHTML =
            '<div class="' +
            rowCls +
            '"' +
            click +
            ">" +
            '<span class="tag ' +
            tag.c +
            '">' +
            tag.t +
            "</span>" +
            '<span class="ev-name">' +
            name +
            "</span>" +
            durStr +
            '<span class="ev-time">' +
            fmtTs(ev.timestamp) +
            "</span>" +
            (hasBody ? '<span class="ev-caret">&#8250;</span>' : "") +
            "</div>" +
            (hasBody ? '<div class="ev-body">' + body + "</div>" : "");
          list.appendChild(el);

          // Eagerly create cc-section right after the tool_started row so
          // output lines always appear directly below the tool call.
          if (
            ev.type === "tool_started" &&
            (d.tool_name === "implement_changes" || d.tool_name === "run_tests")
          ) {
            var sec = document.createElement("div");
            sec.className =
              "cc-section" +
              (d.tool_name === "run_tests" ? " cc-section-terminal" : "");
            sec.innerHTML =
              '<div class="cc-label">' +
              h(ccLabel) +
              "</div>" +
              '<div class="cc-content" id="cc-content-' +
              ccIdx +
              '"></div>';
            sec.querySelector(".cc-label").addEventListener(
              "click",
              function () {
                sec.classList.toggle("expanded");
              },
            );
            list.insertBefore(sec, el.nextSibling);
          }
        }

        // â”€â”€ Claude Code item rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function makeCCItem(d) {
          if (d.tool_name) return makeToolItem(d);
          var txt = (d.text || "").trimEnd();
          if (!txt) return null;

          var el = document.createElement("div");

          // Unordered list item: "- text" or "* text"
          var ul = txt.match(/^(\s*)[*\-]\s+(.+)$/);
          if (ul) {
            el.className = "cc-li";
            el.style.paddingLeft = 18 + ul[1].length * 10 + "px";
            el.innerHTML =
              '<span class="cc-li-sym">â€¢</span><span>' +
              renderMd(ul[2]) +
              "</span>";
            return el;
          }

          // Ordered list item: "1. text"
          var ol = txt.match(/^(\s*)(\d+)\.\s+(.+)$/);
          if (ol) {
            el.className = "cc-li";
            el.style.paddingLeft = 18 + ol[1].length * 10 + "px";
            el.innerHTML =
              '<span class="cc-li-sym">' +
              ol[2] +
              ".</span><span>" +
              renderMd(ol[3]) +
              "</span>";
            return el;
          }

          el.className = "cc-text";
          el.innerHTML = renderMd(txt);
          return el;
        }

        // Simple inline markdown: bold+code, bold, italic, backtick code.
        function renderMd(raw) {
          var s = h(raw);
          // **code** combined with backtick spans
          s = s.replace(
            /\*\*\x60([^\x60]+)\x60\*\*/g,
            '<strong><code class="cc-code">$1</code></strong>',
          );
          // **bold**
          s = s.replace(/\*\*([^*\n]+)\*\*/g, "<strong>$1</strong>");
          // *italic*
          s = s.replace(/\*([^*\n]+)\*/g, "<em>$1</em>");
          // backtick code spans
          s = s.replace(
            /\x60([^\x60\n]+)\x60/g,
            '<code class="cc-code">$1</code>',
          );
          return s;
        }

        function makeToolItem(d) {
          var name = d.tool_name || "";
          var input = {};
          try {
            input = JSON.parse(d.tool_input || "{}");
          } catch (e) {}

          if (name === "Edit" || name === "Write")
            return makeDiffItem(name, input);
          if (name === "TodoWrite") return makeTodosItem(input);

          // Simple one-line tool row.
          var arg = toolArg(name, input);
          var el = document.createElement("div");
          el.className = "cc-row";
          el.innerHTML =
            '<span class="cc-arrow">â€º</span>' +
            '<span class="cc-nm">' +
            h(name) +
            "</span>" +
            (arg ? '<span class="cc-arg">' + h(arg) + "</span>" : "");
          return el;
        }

        function toolArg(name, input) {
          var keys = [
            "file_path",
            "command",
            "path",
            "pattern",
            "glob",
            "query",
            "description",
          ];
          for (var i = 0; i < keys.length; i++) {
            var v = input[keys[i]];
            if (typeof v === "string" && v) {
              var s = v.replace(/^\/workspace\/[^\/]+\//, "");
              return s.length > 72 ? s.slice(0, 72) + "\u2026" : s;
            }
          }
          return "";
        }

        function makeDiffItem(toolName, input) {
          var fp = input.file_path || "";
          var short = fp.replace(/^\/workspace\/[^\/]+\//, "") || fp;
          var oldS = input.old_string || "";
          var newS = input.new_string || input.content || "";

          var MAX = 24;
          var oldLines = oldS.split("\n");
          var newLines = newS.split("\n");
          var oldOver = oldLines.length > MAX;
          var newOver = newLines.length > MAX;
          if (oldOver) oldLines = oldLines.slice(0, MAX);
          if (newOver) newLines = newLines.slice(0, MAX);

          var body = "";
          oldLines.forEach(function (l) {
            body += '<div class="dl dl-del">- ' + h(l) + "</div>";
          });
          if (oldOver)
            body += '<div class="dl dl-sep">\u2026 truncated \u2026</div>';
          newLines.forEach(function (l) {
            body += '<div class="dl dl-add">+ ' + h(l) + "</div>";
          });
          if (newOver)
            body += '<div class="dl dl-sep">\u2026 truncated \u2026</div>';

          var el = document.createElement("div");
          el.className = "cc-diff";
          el.innerHTML =
            '<div class="cc-diff-hdr">' +
            '<span class="cc-arrow">â€º</span>' +
            '<span class="cc-nm">' +
            h(toolName) +
            "</span>" +
            '<span class="cc-diff-path">' +
            h(short) +
            "</span>" +
            "</div>" +
            '<div class="diff-lines">' +
            body +
            "</div>";
          return el;
        }

        function makeTodosItem(input) {
          var todos = input.todos || [];
          if (!todos.length) return null;
          var el = document.createElement("div");
          el.className = "cc-todos";
          todos.forEach(function (t) {
            var status = t.status || "pending";
            var icon =
              status === "completed"
                ? "\u2713"
                : status === "in_progress"
                  ? "\u25cf"
                  : "\u25cb";
            var row = document.createElement("div");
            row.className = "cc-todo todo-" + status;
            row.innerHTML =
              '<span class="todo-i">' +
              icon +
              '</span><span class="todo-t">' +
              h(t.content || "") +
              "</span>";
            el.appendChild(row);
          });
          return el;
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function evTag(ev) {
          switch (ev.type) {
            case "job_started":
              return { c: "tag-job", t: "Job" };
            case "job_completed":
              return { c: "tag-done", t: "Done" };
            case "job_error":
              return { c: "tag-err", t: "Error" };
            case "llm_call":
              return { c: "tag-llm", t: "LLM Call" };
            case "llm_response":
              return { c: "tag-llm", t: "LLM" };
            case "tool_started":
              return { c: "tag-tool", t: "Tool" };
            case "tool_completed":
              return { c: "tag-tool", t: "Tool Done" };
            case "slack_notification":
              return { c: "tag-slack", t: "Slack" };
            default:
              return { c: "tag-job", t: ev.type };
          }
        }

        function evName(ev) {
          var d = ev.data || {};
          switch (ev.type) {
            case "job_started":
              return h((d.task || "").slice(0, 90));
            case "job_completed":
              return (
                '<span class="ev-ok">&#10003;</span> ' +
                h((d.final_response || "Done").slice(0, 80))
              );
            case "job_error":
              return (
                '<span class="ev-err">&#10007;</span> ' +
                h((d.error || "error").slice(0, 80))
              );
            case "llm_call":
              return d.iteration !== undefined
                ? "iteration " + d.iteration
                : "";
            case "llm_response":
              return h((d.summary || d.stop_reason || "").slice(0, 90));
            case "tool_started":
              return "<strong>" + h(d.tool_name || "") + "</strong>";
            case "tool_completed": {
              var ok = d.is_error
                ? '<span class="ev-err">&#10007; error</span>'
                : '<span class="ev-ok">&#10003;</span>';
              return "<strong>" + h(d.tool_name || "") + "</strong>  " + ok;
            }
            case "slack_notification":
              return h((d.text || "").slice(0, 90));
            default:
              return h(ev.type);
          }
        }

        function evBody(ev) {
          var d = ev.data || {};
          switch (ev.type) {
            case "tool_started": {
              if (!d.input) return "";
              var inp = d.input;
              try {
                inp = JSON.stringify(JSON.parse(d.input), null, 2);
              } catch (e) {}
              return h(inp);
            }
            case "tool_completed": {
              if (!d.result_preview) return "";
              return d.is_error
                ? '<span style="color:var(--red)">' +
                    h(d.result_preview) +
                    "</span>"
                : h(d.result_preview);
            }
            case "llm_response":
              return d.summary ? h(d.summary) : "";
            case "job_started": {
              var parts = [];
              if (d.task) parts.push("Task     " + d.task);
              if (d.slack_thread_url)
                parts.push("Slack    " + d.slack_thread_url);
              if (d.channel) parts.push("Channel  " + d.channel);
              return parts.length ? h(parts.join("\n")) : "";
            }
            case "job_completed":
              return d.final_response ? h(d.final_response) : "";
            case "job_error":
              return d.error
                ? '<span style="color:var(--red)">' + h(d.error) + "</span>"
                : "";
            default:
              return "";
          }
        }

        function tog(row) {
          var ev = row.closest(".ev");
          ev.classList.toggle("closed");
          ev.classList.toggle("open");
        }
        window.tog = tog;

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        function app(html) {
          document.getElementById("app").innerHTML = html;
        }

        function h(s) {
          return String(s)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
        }

        function enc(s) {
          return encodeURIComponent(String(s));
        }

        function fmtTs(ts) {
          if (!ts) return "";
          return new Date(ts).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        }

        function relTime(ts) {
          if (!ts) return "";
          var diff = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
          if (diff < 60) return diff + "s ago";
          if (diff < 3600) return Math.floor(diff / 60) + "m ago";
          if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
          return Math.floor(diff / 86400) + "d ago";
        }
      })();
    </script>
  </body>
</html>
